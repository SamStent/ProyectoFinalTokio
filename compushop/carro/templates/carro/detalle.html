{% extends "tienda/base.html" %}
{% load static %}

{% block title %}
  Tu carrito
{% endblock %}

{% block content %}
<div class="container py-5">
  <h2 class="mb-4">Tu carrito</h2>

  {% if carro %}
    <table class="table table-hover align-middle text-center">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Producto</th>
          <th>Imagen</th>
          <th>Precio unitario</th>
          <th>Cantidad</th>
          <th>Total</th>
          <th>Actualizar</th>
          <th>Eliminar</th>
        </tr>
      </thead>
      <tbody>
        {% for item in carro %}
        {% with producto=item.producto %}
        <tr>
          <td>{{ producto.id }}</td>
          <td>{{ producto.nombre }}</td>
          <td>
            <a href="{{ producto.get_absolute_url }}">
              <img src="{% if producto.imagen %}{{ producto.imagen.url }}{% else %}{% static 'img/no_image.png' %}{% endif %}" alt="{{ producto.nombre }}" width="60" height="60" class="img-thumbnail">
            </a>
          </td>
          <td>{{ item.precio }} ‚Ç¨</td>
          <td>{{ item.cantidad }}</td>
          <td><strong>{{ item.precio_total }} ‚Ç¨</strong></td>

          <!-- Formulario actualizar -->
          <td>
            <form action="{% url 'carro:aniadir_a_carro' producto.id %}" method="post" class="d-flex">
              {% csrf_token %}
              {{ item.formulario_actualizar_cantidad.cantidad }}
              <input type="submit" value="Actualizar" class="btn btn-sm btn-outline-primary ms-2">
            </form>
          </td>

          <!-- Formulario eliminar -->
          <td>
            <form action="{% url 'carro:eliminar_carro' producto.id %}" method="post">
              {% csrf_token %}
              <input type="submit" value="Eliminar" class="btn btn-sm btn-outline-danger">
            </form>
          </td>
        </tr>
        {% endwith %}
        {% endfor %}

        {% if carro.cupon %}
        <!-- Subtotal sin descuento -->
        <tr class="table-light">
          <td colspan="5" class="text-end fw-semibold">Subtotal:</td>
          <td>{{ carro.precio_total }} ‚Ç¨</td>
          <td colspan="2"></td>
        </tr>

        <!-- Descuento aplicado -->
        <tr class="table-warning">
          <td colspan="5" class="text-end">
            Cup√≥n "<strong>{{ carro.cupon.codigo }}</strong>" ({{ carro.cupon.descuento }}% de descuento)
          </td>
          <td class="text-danger">
            - {{ carro.obtener_descuento|floatformat:2 }} ‚Ç¨
          </td>
          <td colspan="2"></td>
        </tr>

        <!-- Total final con descuento -->
        <tr class="table-success fw-bold">
          <td colspan="5" class="text-end">Total:</td>
          <td>{{ carro.total_con_descuento|floatformat:2 }} ‚Ç¨</td>
          <td colspan="2"></td>
        </tr>
      {% else %}
        <!-- Total sin descuento -->
        <tr class="table-success fw-bold">
          <td colspan="5" class="text-end">Total:</td>
          <td>{{ carro.precio_total }} ‚Ç¨</td>
          <td colspan="2"></td>
        </tr>
      {% endif %}        

      </tbody>
    </table>

    <!-- Formulario para aplicar cup√≥n -->
    <div class="card my-4">
      <div class="card-header">
        ¬øTienes un cup√≥n de descuento?
      </div>
      <div class="card-body">
        <form action="{% url 'cupones:aplicar' %}" method="post" class="row g-2 align-items-center">
          {% csrf_token %}
          <div class="col-auto">
            {{ formulario_aplicar_cupon.codigo.label_tag }}
          </div>
          <div class="col">
            {{ formulario_aplicar_cupon.codigo }}
          </div>
          <div class="col-auto">
            <button type="submit" class="btn btn-outline-primary">Aplicar cup√≥n</button>
          </div>
        </form>
      </div>
    </div>


    <!-- Botones -->
    <div class="d-flex justify-content-between">
      <a href="{% url 'tienda:listado_productos' %}" class="btn btn-outline-secondary">üõçÔ∏è Seguir comprando</a>
      <a href="{% url 'ordenes:crear_orden' %}" class="btn btn-success">‚úÖ Finalizar pedido</a>
    </div>

  {% else %}
    <div class="alert alert-info">
      Tu carrito est√° vac√≠o. <a href="{% url 'tienda:listado_productos' %}" class="alert-link">Comienza a comprar</a>.
    </div>
  {% endif %}
</div>
{% endblock %}
